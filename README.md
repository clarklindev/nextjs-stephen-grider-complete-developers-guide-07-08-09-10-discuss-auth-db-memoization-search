# section 07 Authentication

<img
src='exercise_files/59-project-overview.png'
alt='59-project-overview.png'
width=600
/>

## 59. project overview
    - reddit clone
    - authentication
    - topics
    - comments

- Home

<img
src='exercise_files/59-1-home.png'
alt='59-1-home.png'
width=600
/>

- create a topic

<img
src='exercise_files/59-2-create-a-topic.png'
alt='59-2-create-a-topic.png'
width=600
/>

- view topic

<img
src='exercise_files/59-3-view-topic.png'
alt='59-3-view-topic.png'
width=600
/>

- create a post

<img
src='exercise_files/59-4-create-a-post.png'
alt='59-4-create-a-post.png'
width=600
/>

- view a post

<img
src='exercise_files/59-5-view-a-post.png'
alt='59-5-view-a-post.png'
width=600
/>

## 60. npm libraries
- nextui
- prisma -> sqlite db
- next-auth -> authjs (renamed)
- github Oauth

## 61. nexui installation and setup
- package.json already has lib added from starter files
- framer-motion is required by nextui
- tailwind.config.ts

```ts
//...
import {nextui} from '@nextui-org/react';


export default {
  content: [
    //...
    './node_modules/@nextui-org/theme/dist/**/*.{js,ts,jsx,tsx}'
  ],
  theme: {
    extend: {
      colors: {
        background: "var(--background)",
        foreground: "var(--foreground)",
      },
    },
  },
  darkMode: "class",
  plugins: [nextui()],
} satisfies Config;

```

```tsx
//src/app/providers.tsx
'use client';

import {NextUIProvider} from '@nextui-org/react';

interface ProvidersProps{
    children: React.ReactNode
}

export default function Providers({children}:ProvidersProps){
    return <NextUIProvider>{children}</NextUIProvider>
}
```
- then add to src/app/layout.tsx

```tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import  Providers from '@/app/providers';

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <Providers>
        <body className={inter.className}>{children}</body>
      </Providers>
    </html>
  );
}

```

## 63. database setup


```sh
npx prisma init --datasource-provider sqlite
```

### create schema
- this creates the schema `prisma/schema.prisma`

### replace schema
- replace with the given schema.prisma from lesson 62 (given)
- it has data models:

- model Account
- model Session
- model User
- model VerificationToken
- model Topic
- model Post
- model Comment

### create db
- call this to create the db
- note the .env variable -> DATABASE_URL="file:./dev.db"
- give migration a name eg. `init`

```sh
npx prisma migrate dev
```

- this puts a dev.db in `prisma/`
- create src/db/index.ts

```ts
//src/db/index.ts
import {PrismaClient} from '@prisma/client';

export const db = new PrismaClient();

```

## 64. OAuth setup

- Auth Setup

<img
src='exercise_files/64-auth-setup.png'
alt='64-auth-setup.png'
width=600
/>

- oauth flow

<img
src='exercise_files/64-oauth-flow.png'
alt='64-oauth-flow.png'
width=600
/>

- steps 1-3
## 1. authentication will flow through [github oauth](http://github.com/settings/applications/new).

### create oauth app
    - create an OAuth App and generate a client_id and client_secret
    - Application name: Dev Discuss
    - Homepage URL: http://localhost:3000
    - Authorization callback URL: http://localhost:3000/api/auth/callback/github 
    - click -> Register application

### generate client ID / secret
    - generates Client ID
    - generate a new client Secret

<img
src='exercise_files/64-github-oauth.png'
alt='64-github-oauth.png'
width=600
/>

## 2. .env.local file
- create in root: `.env.local`
- AUTH_SECRET is random string of letters you choose

```
GITHUB_CLIENT_ID=""
GITHUB_CLIENT_SECRET=""
AUTH_SECRET=""

```

## 3. install npm packages
- tutorial use exact version

```sh
npm install --save-exact @auth/core@0.18.1 @auth/prisma-adapter@1.0.6 next-auth@5.0.0-beta.3
```

## 65. Next-Auth Setup
## 4. make a auth.ts in src/ and setup NextAuth and PrismaAdapter in there

- inside schema.prisma -> models automatically used by `PrismaAdapter`
    - model Account
    - model Session
    - model User 
    - model VerificationToken

- when signing up will need the specific User properties (see `prisma/schema.prima` model):
    name          String?
    email         String?   @unique
    emailVerified DateTime?
    image         String?
    accounts      Account[]
    sessions      Session[]

```ts
//src/auth.ts
import NextAuth from 'next-auth';
import Github from 'next-auth/providers/github';
import { PrismaAdapter } from '@auth/prisma-adapter';
import { db } from '@/db';

const GITHUB_CLIENT_ID = process.env.GITHUB_CLIENT_ID;
const GITHUB_CLIENT_SECRET = process.env.GITHUB_CLIENT_SECRET;

if (!GITHUB_CLIENT_ID || !GITHUB_CLIENT_SECRET) {
  throw new Error('Missing github oauth credentials');
}

export const {
  handlers: { GET, POST },
  auth,
  signOut,
  signIn,
} = NextAuth({
  adapter: PrismaAdapter(db),
  providers: [
    Github({
      clientId: GITHUB_CLIENT_ID,
      clientSecret: GITHUB_CLIENT_SECRET,
    }),
  ],
  callbacks: {
    // Usually not needed, here we are fixing a bug in nextauth
    async session({ session, user }: any) {
      if (session && user) {
        session.user.id = user.id;
      }
      return session;
    },
  },
});
```

## 66. The Theory Behind OAuth
- set up the `app/api/auth[...nextauth]/route.ts` file to handle the request between Githubs Servers and ours
- `route.ts` file inside app/ is special in that you can export `GET` and `POST` functions (implement API handlers inside Nextjs app)
- we usually use actionhandlers within our own apps. 
- we would use route.ts to create GET and POST for outside servers to access our app automatically (eg. github server) 
- will use GET, POST from nextAuth

```ts
// app/api/auth[...nextauth]/route.ts
export { GET, POST} from '@/auth'
```

- @3min33sec

- Oauth flow

<img
src='exercise_files/64-oauth-flow.png'
alt='64-oauth-flow.png'
width=600
/>

- most of oauth flow is handled behind the scenes, we just need to make sure of the `Authorization callback url`

### Requests made by users browser
1. user clicks on sign up button
2. users browser causes request to backend (NEXT SERVER) 
3. we realise user is trying to signup, so we redirect to (github server WITH client_id)  
  - `github.com/login/oauth/authorize?client_id=123`
4. github asks user if they are OK sharing information with our app. if so they redirect back to our server
  - callback url from github auth setup
  - `localhost:3000/api/auth/github/callback?code=456`

### Communication between (our server) and (github)
5. our server takes 'code' off request and makes a follow up request to Github
  - `github.com/login/oauth/access_token` `{clientId, clientSecret, code}`
6. github makes sure the {clientD, clientSecret and code} are valid then responds with an "access_token"
7. if valid responds with access_token
  - `access_token=abc123`
8. we make another request with the access_token to get details about the user (name, email etc)
  - `api.github.com/user` `Authorization: Bearer abc123`
9. github responds with the user's profile
  {name, email, avatar}
10. we create a new "User" record in the database
11. we send a cookie back to the users browser which will be included with all future requests automatically. That cookie tells us who is making a request to our server

## 67. wrapping auth in Server Actions
- make server actions to signin/signout the user (optional)
- `src/actions/index.ts`

```ts
// src/actions/index.ts

'use server';

import * as auth from '@/auth';

export async function signIn(){
    return auth.signIn('github');   //passin what provider we want to signin with
}

export async function signOut(){
    return auth.signOut();
}
```